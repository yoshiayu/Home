# Home
# 要件定義ぜんぶのせ入門（改訂版）— Spring直前・実務直結

対象：プログラミング2年目（1年Python／2年Java）／フレームワーク前：Spring Boot に入る直前  
題材：オンラインカフェ注文アプリ（Java／PostgreSQL）

---
## この改訂での追加点（要約）
- **実務の型**：RACI、DoR/DoD、ADR、変更要求（CR）、リスクログ、ミスユースケース（Threat Modeling）
- **SRS（仕様書）テンプレ & サンプル**：学内課題→社内合意文書へ橋渡し
- **非機能要件の数値化**：性能（P95等）、セキュリティ最小セット、アクセシビリティの要点
- **Spring 橋渡し**：FR→Controller/Service/Repository へのマッピング、Validation/例外/Tx
- **OpenAPI スタブ**：API仕様の土台を同梱（抜粋を本書にも掲載）
- **演習と模範解答**：各章に配置（学生が詰まらないよう“答えの骨子”を明記）
- **トレーサビリティ強化**：要件→設計→テストの連結表テンプレを拡充

---
## 0. ことば合わせ（超基礎：ここが土台）
### 0-1. 「要求」と「要件」
- **要求（ニーズ）**：利用者の願い・不満・したいこと  
  例）「行列に並ばずに、スマホで事前注文したい」
- **要件（仕様）**：要求を満たすために**システムが備える条件**  
  例）「スマホ画面からメニューを選び、決済または店頭支払いで**注文確定できる**こと」

### 0-2. 機能要件と非機能要件
- **機能要件（FR = Functional Requirement）**：システムが「できること」
- **非機能要件（NFR = Non-Functional Requirement）**：速さ・安全・使いやすさ・運用などの「品質条件」

### 0-3. ID の付け方（FR-01 とは？）
- `FR-01` … 機能要件の1番、`NFR-02` … 非機能要件の2番  
- 目的：**漏れなく管理**し、**設計やテストと線で結ぶ**（トレーサビリティ）

### 0-4. 受け入れ条件（AC = Acceptance Criteria）
- **“できたか判定するチェック項目”**。テストで○×が付けられる書き方にする。

---
## 1. ヒアリング（要求抽出）—「願い」を整然と聞く
### 1-1. 4つの質問テンプレ
1) **誰が**（ペルソナ）／ 2) **いつ・どこで**（利用場面）／ 3) **何に困って**（課題）／ 4) **どうなれば嬉しい**（価値）

### 1-2. 例（オンラインカフェ）
- ペルソナ：**忙しい大学生**（休み時間10分／スマホ）  
- 課題：レジ待ちが長い→休み時間に間に合わない  
- 価値：事前にスマホで確定→**すぐ受け取れる**

### 1-3. 成果物テンプレ（要求メモ）
```
[ペルソナ] 忙しい大学生（スマホ/休み時間10分）
[課題] レジ行列で時間が足りない
[価値] 待ち時間ゼロで受け取りたい
[制約] 校内電波が弱い時間帯あり
```

#### 演習1（10分）
- 「**店員**」「**管理者**」の要求メモも作る。

**模範解答（要約）**  
- 店員：紙伝票が読みにくい→**キッチン画面で時系列表示**  
- 管理者：手集計が大変→**日付/カテゴリ別の売上が出る**

---
## 2. ユーザーストーリー & 受け入れ条件（AC）
### 2-1. ユーザーストーリー（型）
> **私は〈誰〉として、〈何をしたい〉。なぜなら〈理由〉。**  
例）「私は学生として、**スマホで事前注文**したい。**行列を避けたい**から。」

### 2-2. AC の例
- AC1：メニュー選択から**3ステップ以内で確定**できる  
- AC2：数量変更で**合計金額が1秒以内に更新**される  
- AC3：確定後に**注文番号と受取QR**が表示される

### 2-3. ユースケース（だれが何をするか）
- UC-01 検索／UC-02 カート／UC-03 確定／UC-04 提供更新／UC-05 売上集計

#### 演習2（15分）
- 「**注文を確定する**」のユーザーストーリー1本＋AC3つを書く。

**模範解答（例）**  
ストーリー：常連として、保存カードで**ワンタップ確定**したい。毎回番号を入れたくないから。  
AC1：保存カードのトークン決済成功時のみ確定／AC2：確定後に**QRと受取時刻**を表示／AC3：失敗時は**理由つきエラー**と**リトライ**

---
## 3. 要求一覧（ここが“FR-01/NFR-01”の本体）
### 3-1. 書き方テンプレ
| ID | 種別 | 要件（動詞で具体的に） | 理由/価値 | 優先 | 受け入れ条件（テスト観点） |
|---|---|---|---|---|---|

### 3-2. 完成例（最少コア）
| ID | 種別 | 要件 | 理由 | 優先 | 受け入れ条件 |
|---|---|---|---|---|---|
| **FR-01** | 機能 | 顧客はカテゴリ/キーワードで**商品検索できる** | 目的商品へ素早く到達 | 高 | 部分一致/カテゴリ絞り/価格昇降ソート |
| **FR-02** | 機能 | 顧客は商品を**カートに追加・数量変更**できる | まとめ買い対応 | 高 | 追加/削除/数量1〜99、合計金額即時計算 |
| **FR-03** | 機能 | 顧客は**注文を確定**できる（現金/カード） | 事前注文成立 | 高 | カート空不可、確定後に注文番号とQR |
| **FR-04** | 機能 | 店員は注文の**提供ステータス更新**ができる | 受け渡しミス防止 | 高 | 未提供→提供中→提供済みのみ許可 |
| **FR-05** | 機能 | 管理者は**売上集計**を見られる | 仕込み最適化 | 中 | 期間指定、CSV出力 |
| **NFR-01** | 非機能 | **P95 1.5秒以下**（同時100ユーザー） | 待ち時間削減 | 中 | JMeter測定でP95≦1.5s |
| **NFR-02** | 非機能 | **BCryptでパスワードハッシュ保存** | 安全性 | 高 | 平文保存禁止、検証実施 |

#### 演習3（15分）
- 混雑対策のため「**受け取り時刻予約**」を FR-06 として追記。要件文／理由／優先／ACを埋める。

**模範解答（例）**  
FR-06：顧客は**15分刻みで受け取り時刻を予約**できる。理由：混雑平準化。優先：高  
AC：(1) 営業時間内のみ (2) 満枠は選べない (3) 確定後に**予約時刻**が注文に保存

---
## 4. 外部設計（画面・データ：ユーザーに見える設計）
### 4-1. 画面一覧（抜粋）
- G-01 ログイン／G-02 メニュー一覧／G-03 商品詳細／G-04 カート／G-05 確定／G-06 履歴QR  
- G-11 店員ダッシュボード／G-21 管理者レポート

### 4-2. 画面項目表テンプレ
| 画面ID | 画面名 | 目的 | 主操作 | 入力項目 | 出力項目 | 遷移 |
|---|---|---|---|---|---|---|

**例：G-05 注文確認→確定**：入力（支払方法・受取時刻・同意）、出力（合計・注文番号・QR）、バリデーション（同意必須、空カート不可）

### 4-3. ER 図（要点）
- **User 1—* Order**／**Order 1—* OrderItem**／**OrderItem *—1 MenuItem**／**MenuItem *—1 Category**  
- 履歴再現のため **OrderItem.unit_price** を保持

### 4-4. DDL（PostgreSQL：抜粋）
- `users / categories / menu_items / orders / order_items`（CHECK/UNIQUE/FK あり）

#### 演習4（20分）
- **レビュー機能**をERとDDLに追加（購入者のみ／1〜5／300字／非表示／一意制約）。

**模範DDL（抜粋）**
```sql
CREATE TABLE reviews (
  id SERIAL PRIMARY KEY,
  user_id INT NOT NULL REFERENCES users(id),
  menu_item_id INT NOT NULL REFERENCES menu_items(id),
  rating INT NOT NULL CHECK (rating BETWEEN 1 AND 5),
  comment VARCHAR(300),
  is_hidden BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
CREATE UNIQUE INDEX uniq_review_user_item ON reviews(user_id, menu_item_id);
```

---
## 5. 内部設計（クラス図・メソッド仕様：コードの前に“合意”）
### 5-1. クラス図の考え方
- 四角＝クラス、線＝関係（1対多など）／**責務は1クラス1つ**を意識

### 5-2. 代表メソッド仕様テンプレ
```
メソッド: calcTotal
事前条件: items.size() >= 1
事後条件: 各行 (unitPrice * quantity) の合計を返す
例外: IllegalStateException（空注文）
副作用: なし
```

#### 演習5（10分）
- `Order.cancel()` の **事前/事後/例外** を文章で仕様化。

**模範（要約）**  
事前：`status != PAID`／事後：`status == CANCELLED`／例外：`IllegalStateException`（PAIDからは不可）

---
## 6. テスト（単体/結合/受け入れ：証拠づくり）
### 6-1. 単体テスト観点
- 正常／境界／例外。副作用の有無も確認。

### 6-2. 例（JUnit）
```java
@Test
void calcTotal_複数商品で合計が正しい() {
  var order = Fixtures.sampleOrder(); // 300x2 + 250 = 850
  assertEquals(850, order.calcTotal());
}
```

### 6-3. 受け入れテスト（AC直結）
- AT-01：数量変更で合計**1秒以内更新**（FR-02）  
- AT-02：**空カートで確定不可**（FR-03）  
- AT-03：確定後**注文番号＋QR**表示（FR-03）

#### 演習6（15分）
- 好きなACを1つ選び、**Given/When/Then**でケース化。

**模範（要約）**  
Given：在庫OK／カート3明細 → When：確定 → Then：注文番号・QR生成／カート空

---
## 7. トレーサビリティ（要件→設計→テストを“線で結ぶ”）
| 要件ID | 画面 | テーブル/列 | クラス/メソッド | テストID |
|---|---|---|---|---|
| FR-02 | G-04 | ORDER_ITEMS.quantity | Order.addItem / calcTotal | UT-02, AT-01 |
| FR-03 | G-05 | ORDERS.status / pickup_qr | Order.cancel / markPaid | UT-03, AT-02, AT-03 |
| FR-06 | G-05 | ORDERS.pickup_slot | Order.setPickupSlot | AT-06 |

#### 演習7（10分）
- **FR-06（受け取り時刻）**の関連を上表に追記。

**模範追記**（上表の3行目を参照）

---
## 8. 非機能要件（NFR）と数値化のコツ
- **性能**：例）P95 応答 ≤ 1.5s（同時100ユーザー、JMeterで計測／ウォームアップ除外）  
- **セキュリティ**：パスワードはBCrypt、SQLはバインド、重要操作を構造化ログに記録  
- **可用性**：稼働率 99.5% / 月、バックアップ/リストア手順  
- **アクセシビリティ**：コントラスト、キーボード操作、ラベル、色依存の回避

#### 追加演習A（10分） NFRの数値化
- 「高速」「安全」を**測定可能**に書き換える。  
**模範**：P95≦1.5s、P99≦2.5s／パスワードBCrypt／認可はRBAC

---
## 9. 実務の型（現場で通じる作法）
- **RACI**：責任分担（例）PO=責任、TL=実行、QA=検証、Scribe=記録  
- **DoR（Ready）**：ストーリー＋AC、依存関係、見積可能性  
- **DoD（Done）**：テスト緑、ドキュメント更新、トレーサ表更新、レビュー完了  
- **ADR**：設計決定の背景・選択肢・影響を1ページで残す  
- **変更要求（CR）**：理由／影響範囲（要件ID・画面・DDL・クラス・テスト）／期限／承認  
- **Threat Modeling（ミスユースケース）**：不正注文・リプレイ・連打対策（レート制限、Idempotency Key、監査ログ）

#### 追加演習B（10分） 変更要求
- **受取時刻**を15分→10分に変更。影響箇所を洗い出す。  
**模範**：FR-06/AC、G-05、スロット定義、`setPickupSlot`、受け入れテスト更新。

---
## 10. Spring への橋渡し（設計→コード）
### 10-1. FR↔API マッピング（例）
| 要件ID | Controller | HTTP | Path | 概要 |
|---|---|---|---|---|
| FR-01 | MenuItemController | GET | /api/v1/menu-items | 検索/絞込/ソート |
| FR-02 | CartController | POST | /api/v1/cart/items | 追加/数量変更 |
| FR-03 | OrderController | POST | /api/v1/orders | 注文確定（現金/カード） |
| FR-04 | StaffOrderController | PATCH | /api/v1/staff/orders/{id} | 状態遷移 |
| FR-05 | ReportController | GET | /api/v1/reports/sales | 集計/CSV |

### 10-2. Validation/例外/Tx（指針）
- `@Valid`／`@NotNull`／`@Min(1)`／`@Pattern` 等で入力検証  
- `@ControllerAdvice` で例外を一元ハンドリング（400/403/404/409）  
- ビジネス操作は `@Transactional` を付与

#### 追加演習C（10分） OpenAPI 追記
- `/api/v1/reports/sales?from&to&categoryId?` を定義し、200/400/401/403 を記述。  
**模範**：200=集計配列、400=日付不正、401/403=認可、429=制限。

---
## 11. SRS（仕様書）テンプレ（簡易）
```
1. 目的 / 2. 範囲 / 3. 用語 / 4. 参照
5. 全体記述（利用者/制約/仮定）
6. 機能要件（FR-xx と AC）
7. 非機能要件（NFR-xx）
8. 画面一覧・ワイヤー
9. データ定義（ER/DDL 概要）
10. 外部I/F（API）
11. 受け入れテスト計画
12. 変更管理・リスク
```

**サンプル（抜粋）**  
- FR-03：顧客は注文を確定できる（現金/カード）。AC：空カート不可／成功で注文番号とQR。  
- NFR-01：同時100ユーザーで P95 1.5s 以下。

---
## 12. 授業運営と評価（社会人の型を練習する）
- 90分×4回：①ヒアリング→AC、②要求/画面/ER、③内部/API、④テスト/トレーサ/発表  
- 役割：PO / TL / QA / Scribe（毎回ローテ）  
- **採点ルーブリック（各20点）**：要件具体性・ER/DDL・クラス/仕様・テスト網羅・トレーサ/可読性

---
## 付録：テンプレ & チェックリスト（抜粋）
### A. 要求一覧テンプレ
| ID | 種別 | 要件（動詞で） | 理由/価値 | 優先 | 受け入れ条件 |
|----|------|----------------|-----------|------|--------------|

### B. 画面項目表テンプレ
| 画面ID | 画面名 | 目的 | 主操作 | 入力項目 | 出力項目 | 遷移 |
|---|---|---|---|---|---|---|

### C. トレーサビリティ表テンプレ
| 要件ID | 画面 | テーブル/列 | クラス/メソッド | テストID |
|---|---|---|---|---|

### D. OpenAPI（抜粋：YAML）
```yaml
openapi: 3.0.3
info: { title: Cafe Ordering API, version: "1.0.0" }
servers: [{ url: /api/v1 }]
paths:
  /orders:
    post:
      summary: Create order
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                paymentMethod: { type: string, enum: [cash, card] }
                pickupSlot: { type: string }
      responses:
        '201': { description: Created }
        '400': { description: Bad Request }
        '409': { description: Conflict }
```

---
## まとめ（道筋を固定）
1) **ペルソナ→ストーリー→AC**（言葉の設計）  
2) **画面/ER**（目に見える設計）  
3) **クラス/メソッド仕様**（コードの設計）  
4) **テスト**（できたの証拠）  
5) **IDで全部をひも付け**（トレーサビリティ）  
→ Spring 実装に入っても迷子にならない。
